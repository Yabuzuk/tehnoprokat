# üöÄ –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## ‚ö° –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç –≤ Supabase

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://supabase.com/dashboard/project/pmebqzbjtdmbaoqjfbev)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ `fix-push-notifications.sql`
4. –í—Å—Ç–∞–≤—å—Ç–µ –∏ –Ω–∞–∂–º–∏—Ç–µ **Run**

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTP —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ

–ï—Å–ª–∏ –≤ –ª–æ–≥–∞—Ö SQL –ø–æ—è–≤–∏–ª–∞—Å—å –æ—à–∏–±–∫–∞ –ø—Ä–æ HTTP —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Database ‚Üí Extensions**
2. –ù–∞–π–¥–∏—Ç–µ `http`
3. –ù–∞–∂–º–∏—Ç–µ **Enable**
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –®–∞–≥ 1

### –®–∞–≥ 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor:

```sql
-- –ó–∞–º–µ–Ω–∏—Ç–µ USER_ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT test_push_notification('c2135ae8-e722-4945-8c21-8db317a950d8');
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: `‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!`

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
SELECT 
  created_at,
  title,
  status,
  error_message
FROM push_notification_log 
ORDER BY created_at DESC 
LIMIT 10;
```

### –®–∞–≥ 5: –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
npm run build
npx cap copy android
npx cap sync android
```

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ `push_notification_log`
2. ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω RLS –Ω–∞ `push_tokens` (—Ç.–∫. –Ω–µ—Ç Supabase Auth)
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Firebase
4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
5. ‚úÖ –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞
6. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑
    ‚Üì
INSERT –≤ —Ç–∞–±–ª–∏—Ü—É orders
    ‚Üì
–¢—Ä–∏–≥–≥–µ—Ä auto_send_push_notifications
    ‚Üì
–§—É–Ω–∫—Ü–∏—è send_push_notification
    ‚Üì
–§—É–Ω–∫—Ü–∏—è send_push_via_firebase
    ‚Üì
Firebase FCM API (—á–µ—Ä–µ–∑ PostgreSQL HTTP)
    ‚Üì
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "Token not found"

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
SELECT * FROM push_tokens WHERE user_id = 'YOUR_USER_ID';
```

–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–µ—Ç - –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.

### –ü—Ä–æ–±–ª–µ–º–∞: "HTTP extension not found"

–í–∫–ª—é—á–∏—Ç–µ HTTP —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤ Dashboard ‚Üí Database ‚Üí Extensions.

### –ü—Ä–æ–±–ª–µ–º–∞: "Firebase send failed"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Firebase Server Key:

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—à–∏–±–∫—É
SELECT error_message 
FROM push_notification_log 
WHERE status = 'error' 
ORDER BY created_at DESC 
LIMIT 1;
```

–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ `401 Unauthorized` - –Ω–µ–≤–µ—Ä–Ω—ã–π Firebase Server Key.

## üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**
2. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑
3. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ **–í–æ–¥–∏—Ç–µ–ª—å** (–Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)
4. –ü—Ä–∏–º–∏—Ç–µ –∑–∞–∫–∞–∑
5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "üöö –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç"

## üêõ –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ SQL:
```sql
SELECT * FROM push_notification_log ORDER BY created_at DESC LIMIT 5;
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω—ã:
```sql
SELECT user_id, driver_id, LEFT(token, 20) || '...' as token_preview 
FROM push_tokens 
ORDER BY updated_at DESC;
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä:
```sql
SELECT * FROM pg_trigger WHERE tgname = 'trigger_auto_send_push_notifications';
```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTTP —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ:
```sql
SELECT * FROM pg_extension WHERE extname = 'http';
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```sql
CREATE OR REPLACE VIEW push_stats AS
SELECT 
  DATE(created_at) as date,
  status,
  COUNT(*) as count
FROM push_notification_log
GROUP BY DATE(created_at), status
ORDER BY date DESC, status;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
SELECT * FROM push_stats;
```

## üéâ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏:
- –°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è–º)
- –ü—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
- –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)